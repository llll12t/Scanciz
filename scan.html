<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ข้อมูลสมาชิก</title>
    
    <script src="https://cdn.tailwindcss.com"></script>

    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=sarabun:wght@400;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'sarabun': ['Sarabun', 'sans-serif'],
                    },
                    colors: {
                        'primary-blue': '#0D2A56',
                        'primary-yellow': '#FFB900',
                    }
                }
            }
        }
    </script>
</head>

<body class="bg-slate-100 font-sarabun flex items-center justify-center min-h-screen p-2.5">

    <div class="w-full max-w-md h-[95vh] max-h-[800px] bg-white rounded-3xl shadow-xl overflow-hidden flex flex-col">
        
        <header class="bg-primary-blue text-white p-5 flex justify-between items-center flex-shrink-0">
            <h1 class="text-xl font-semibold">ข้อมูลสมาชิก</h1>
            <div class="w-10 h-10 bg-white/20 rounded-xl"></div>
        </header>

        <main class="p-6 flex-grow flex flex-col justify-between">

            <div id="home-screen" class="hidden h-full flex-col justify-between">
                <div class="flex-grow w-full border border-dashed border-slate-300 rounded-2xl mb-6"></div>
                <div class="flex items-center gap-4">
                    <button class="w-full py-3 px-4 rounded-xl font-bold bg-primary-blue text-white" onclick="showHistory()">ประวัติ</button>
                    <button class="w-full py-3 px-4 rounded-xl font-bold bg-primary-yellow text-primary-blue" onclick="initCameraScanner()">ตรวจสอบ บัตร ปชช</button>
                </div>
            </div>

            <div id="camera-scanner-screen" class="hidden h-full flex-col justify-between text-center">
                <div class="relative w-full flex-grow flex items-center justify-center overflow-hidden rounded-2xl mb-4 bg-black">
                    <video id="video-feed" class="absolute top-0 left-0 w-full h-full object-cover" autoplay playsinline></video>
                    <div id="card-frame" class="absolute w-[90%] pt-[56.25%] border-4 border-white/80 rounded-2xl shadow-[0_0_0_9999px_rgba(0,0,0,0.6)]"></div>
                </div>
                <p id="ocr-status" class="font-semibold text-primary-blue min-h-[24px]">กำลังเริ่มต้นกล้อง...</p>
                <div class="flex items-center gap-4 mt-4">
                    <button class="w-full py-3 px-4 rounded-xl font-bold bg-white text-slate-700 border border-slate-200" onclick="showScreen('manual-input-screen')">กรอกรหัสเอง</button>
                    <button class="w-full py-3 px-4 rounded-xl font-bold bg-white text-slate-700 border border-slate-200" onclick="stopCamera()">ยกเลิก</button>
                </div>
            </div>

            <div id="manual-input-screen" class="hidden h-full flex-col justify-between">
                <div>
                    <h3 class="text-center text-xl font-semibold">กรอกเลขบัตรประชาชน</h3>
                    <div class="bg-white rounded-2xl border border-slate-200 p-8 my-4">
                        <input type="tel" id="manual-id-input" pattern="[0-9]*" placeholder="xxxxxxxxxxxxx" class="w-full text-center text-2xl tracking-widest border-none border-b-2 border-primary-blue py-2 focus:ring-0">
                    </div>
                    <div id="manual-search-status" class="text-center text-red-600 min-h-[20px]"></div>
                </div>
                <div class="flex items-center gap-4">
                    <button class="w-full py-3 px-4 rounded-xl font-bold bg-white text-slate-700 border border-slate-200" onclick="showScreen('home-screen')">กลับหน้าหลัก</button>
                    <button class="w-full py-3 px-4 rounded-xl font-bold bg-primary-yellow text-primary-blue" onclick="handleManualSearch()">ค้นหา</button>
                </div>
            </div>

            <div id="history-screen" class="hidden h-full flex-col justify-between">
                <div>
                    <h3 class="text-center text-xl font-semibold mb-4">ประวัติการเช็คอินล่าสุด</h3>
                    <div id="log-list" class="bg-white rounded-2xl border border-slate-200 p-5 min-h-[200px]">
                        </div>
                </div>
                <div class="mt-6">
                    <button class="w-full py-3 px-4 rounded-xl font-bold bg-white text-slate-700 border border-slate-200" onclick="showScreen('home-screen')">กลับหน้าหลัก</button>
                </div>
            </div>

            <div id="details-screen" class="hidden h-full flex-col justify-between">
                <div>
                    <div class="bg-white rounded-2xl border border-slate-200 p-5 flex gap-4">
                        <div class="flex-grow">
                            <div class="w-20 h-20 bg-slate-200 rounded-xl mb-4"></div>
                            <p class="text-lg font-bold text-primary-blue"><span id="detail-name"></span></p>
                            <p class="text-sm text-slate-500">รหัสนักศึกษา: <span id="detail-student-id"></span></p>
                            <p class="text-sm text-slate-500">เลขบัตร: <span id="detail-national-id"></span></p>
                            <p class="text-sm text-slate-500">หลักสูตร: <span id="detail-course"></span></p>
                            <p class="mt-2">สถานะ: <span id="detail-status" class="font-semibold text-sm py-1 px-3 rounded-full"></span></p>
                        </div>
                        <div class="flex-shrink-0 bg-primary-blue text-white w-24 h-24 rounded-2xl flex flex-col items-center justify-center">
                            <span class="text-sm">เลขที่นั่ง</span>
                            <strong id="detail-seat" class="text-4xl font-bold leading-tight"></strong>
                        </div>
                    </div>
                    <div id="message-box" class="hidden text-center font-bold p-3 rounded-lg mt-5"></div>
                </div>
                <div class="flex items-center gap-4 mt-6">
                    <button id="cancel-button" class="w-full py-3 px-4 rounded-xl font-bold bg-white text-slate-700 border border-slate-200" onclick="initCameraScanner()">สแกนคนถัดไป</button>
                    <button id="confirm-button" class="w-full py-3 px-4 rounded-xl font-bold bg-primary-yellow text-primary-blue" onclick="handleConfirm()">ยืนยันการเข้าร่วม</button>
                </div>
            </div>

        </main>
    </div>

    <canvas id="canvas" class="hidden"></canvas>

   
   <script>
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwBBbtIE7WwUG2IgaXvXU_Z42vxOngXDkhkhG6ADld4jChcBeerWXGZkezLChBkLwIs/exec'; // ⚠️ สำคัญ: แก้ไข URL ตรงนี้
        let currentMemberData = {};
        let videoStream = null;
        let scanInterval = null;
        let isProcessing = false;

        /**
         * ฟังก์ชันสลับหน้าจอที่แก้ไขใหม่
         * @param {string} screenId - ID ของ div หน้าจอที่ต้องการแสดง
         */
        function showScreen(screenId) {
            // ซ่อนทุกหน้าจอ .screen ที่อยู่ใน <main>
            document.querySelectorAll('main > .screen').forEach(screen => {
                screen.classList.add('hidden');
                screen.classList.remove('flex');
            });

            // แสดงเฉพาะหน้าจอเป้าหมาย
            const activeScreen = document.getElementById(screenId);
            if (activeScreen) {
                activeScreen.classList.remove('hidden');
                activeScreen.classList.add('flex');
            }
            
            hideMessage();
        }

        function showMessage(text, type) {
            const msgBox = document.getElementById('message-box');
            msgBox.textContent = text;
            msgBox.className = 'text-center font-bold p-3 rounded-lg mt-5 '; // Reset classes
            if (type === 'success') {
                msgBox.classList.add('bg-green-100', 'text-green-800');
            } else {
                msgBox.classList.add('bg-red-100', 'text-red-800');
            }
            msgBox.classList.remove('hidden');
        }

        function hideMessage() {
            document.getElementById('message-box').classList.add('hidden');
        }

        async function initCameraScanner() {
            showScreen('camera-scanner-screen');
            const video = document.getElementById('video-feed');
            const statusDiv = document.getElementById('ocr-status');
            const constraints = { video: { facingMode: 'environment', width: { ideal: 1920 }, height: { ideal: 1080 } } };
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                videoStream = stream;
                statusDiv.textContent = 'จัดบัตรให้อยู่ในกรอบ...';
                startAutoScan();
            } catch (err) {
                statusDiv.textContent = 'ไม่สามารถเปิดกล้องได้';
                alert('เกิดข้อผิดพลาดในการเปิดกล้อง โปรดตรวจสอบการอนุญาต');
            }
        }

        function stopCamera() {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
            }
            if(scanInterval) {
                clearInterval(scanInterval);
            }
            showScreen('home-screen');
        }
        
        function preprocessImage(canvas) {
            const ctx = canvas.getContext('2d', { willReadFrequently: true });
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            for (let i = 0; i < data.length; i += 4) {
                const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
                data[i] = data[i + 1] = data[i + 2] = avg;
            }
            ctx.putImageData(imageData, 0, 0);
        }

        function startAutoScan() {
            const video = document.getElementById('video-feed');
            const canvas = document.getElementById('canvas');
            const statusDiv = document.getElementById('ocr-status');

            scanInterval = setInterval(async () => {
                if(isProcessing) return;
                isProcessing = true;

                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                canvas.getContext('2d').drawImage(video, 0, 0, video.videoWidth, video.videoHeight);
                preprocessImage(canvas);
                
                try {
                    const { data: { text } } = await Tesseract.recognize(canvas, 'tha+eng');
                    const idMatch = text.match(/\d{1}\s?\d{4}\s?\d{5}\s?\d{2}\s?\d{1}/);
                    
                    if (idMatch && idMatch[0]) {
                        clearInterval(scanInterval);
                        statusDiv.textContent = 'พบเลขบัตรแล้ว! กำลังตรวจสอบ...';
                        const foundId = idMatch[0].replace(/\s/g, '');
                        await handleSearch(foundId);
                    }
                } catch(error) {
                    console.error("OCR Error in interval:", error);
                } finally {
                    isProcessing = false;
                }
            }, 2000);
        }
        
        async function handleManualSearch() {
            const id = document.getElementById('manual-id-input').value;
            const statusDiv = document.getElementById('manual-search-status');
            if(!id || id.length !== 13) {
                statusDiv.textContent = 'กรุณากรอกเลข 13 หลักให้ถูกต้อง';
                return;
            }
            statusDiv.textContent = 'กำลังค้นหา...';
            await handleSearch(id, () => {
                statusDiv.textContent = `ไม่พบข้อมูลสำหรับเลขบัตร: ${id}`;
            });
        }
        
        async function showHistory() {
            showScreen('history-screen');
            const logListDiv = document.getElementById('log-list');
            logListDiv.innerHTML = '<p class="text-center text-slate-500">กำลังโหลด...</p>';

            try {
                const response = await fetch(`${WEB_APP_URL}?action=getLog`);
                const result = await response.json();

                if(result.success && result.data.length > 0) {
                    logListDiv.innerHTML = '';
                    result.data.forEach(log => {
                        const item = document.createElement('div');
                        item.className = 'flex justify-between items-center py-3 border-b border-slate-200 last:border-b-0';
                        const logTime = new Date(log[0]).toLocaleString('th-TH', { hour: '2-digit', minute: '2-digit' });
                        item.innerHTML = `
                            <div class="text-sm text-slate-500">${logTime}</div>
                            <div class="text-right">
                                <div class="font-semibold">${log[2]}</div>
                                <div class="text-sm text-slate-500">${log[1]}</div>
                            </div>
                        `;
                        logListDiv.appendChild(item);
                    });
                } else {
                     logListDiv.innerHTML = '<p class="text-center text-slate-500">ยังไม่มีข้อมูลประวัติ</p>';
                }
            } catch(error) {
                logListDiv.innerHTML = '<p class="text-center text-red-600">ไม่สามารถโหลดข้อมูลได้</p>';
            }
        }

        async function handleSearch(id, onErrorCallback) {
            try {
                const response = await fetch(`${WEB_APP_URL}?action=search&id=${id}`);
                const data = await response.json();
                if (data.found) {
                    if (videoStream) stopCamera();
                    showDetails(data);
                } else {
                    if (onErrorCallback) onErrorCallback();
                    else {
                        alert(`ไม่พบข้อมูลสำหรับเลขบัตร: ${id} ในฐานข้อมูล`);
                        initCameraScanner();
                    }
                }
            } catch (error) {
                alert('การเชื่อมต่อเพื่อค้นหาข้อมูลล้มเหลว');
                if (onErrorCallback) onErrorCallback();
                else initCameraScanner();
            }
        }

        function showDetails(data) {
            currentMemberData.sheet = data;
            document.getElementById('detail-name').textContent = data.name;
            document.getElementById('detail-student-id').textContent = data.studentId;
            document.getElementById('detail-national-id').textContent = data.id;
            document.getElementById('detail-course').textContent = data.course;
            document.getElementById('detail-seat').textContent = data.seat;
            const statusSpan = document.getElementById('detail-status');
            const confirmBtn = document.getElementById('confirm-button');

            statusSpan.className = "font-semibold text-sm py-1 px-3 rounded-full";
            if (data.status === 'เข้าร่วมแล้ว') {
                statusSpan.textContent = 'ยืนยันแล้ว';
                statusSpan.classList.add('bg-green-100', 'text-green-800');
                confirmBtn.style.display = 'none';
            } else {
                statusSpan.textContent = 'รอการยืนยัน';
                statusSpan.classList.add('bg-yellow-100', 'text-yellow-800');
                confirmBtn.style.display = 'block';
            }
            showScreen('details-screen');
        }

        async function handleConfirm() {
            if (!currentMemberData.sheet) return;
            const confirmButton = document.getElementById('confirm-button');
            confirmButton.disabled = true;
            confirmButton.textContent = 'กำลังบันทึก...';
            try {
                const response = await fetch(WEB_APP_URL, {
                    method: 'POST', redirect: 'follow', headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ action: 'confirm', id: currentMemberData.sheet.id, name: currentMemberData.sheet.name })
                });
                const result = await response.json();
                if (result.success) {
                    showMessage('ยืนยันข้อมูลสำเร็จ!', 'success');
                    document.getElementById('confirm-button').style.display = 'none';
                } else {
                    showMessage(`เกิดข้อผิดพลาด: ${result.message}`, 'error');
                    confirmButton.disabled = false;
                    confirmButton.textContent = 'ยืนยันการเข้าร่วม';
                }
            } catch (error) {
                showMessage('การเชื่อมต่อผิดพลาด', 'error');
                confirmButton.disabled = false;
                confirmButton.textContent = 'ยืนยันการเข้าร่วม';
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => { showScreen('home-screen'); });
    </script>

</body>
</html>
