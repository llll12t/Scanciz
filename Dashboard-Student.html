<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=sarabun:wght@400;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 'sarabun': ['Sarabun', 'sans-serif'] },
                    colors: { 'primary-blue': '#110D42', 'primary-yellow': '#FFB900' }
                }
            }
        }
    </script>
    <style>
        @keyframes flash-green { 0% { background-color: #d1fae5; } 100% { background-color: transparent; } }
        .flash-success { animation: flash-green 1s ease; }
    </style>
</head>

<body class="bg-slate-100 font-sarabun">
    <div class="container mx-auto p-4 sm:p-6">

        <header class="mb-6">
            <h1 class="text-3xl font-bold text-primary-blue">‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h1>
            <p class="text-slate-500">‡πÄ‡∏û‡∏¥‡πà‡∏° ‡∏•‡∏ö ‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>
        </header>

        <div class="bg-white p-4 rounded-xl shadow-sm mb-6 flex flex-col sm:flex-row justify-between items-start gap-4">
            <div class="flex-grow w-full">
                <label for="course-filter" class="text-sm font-semibold text-slate-600">‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£</label>
                <select id="course-filter" onchange="filterAndDisplayData()"
                    class="w-full mt-1 p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary-yellow focus:border-primary-blue"></select>
            </div>
             <div class="flex gap-2 self-end w-full sm:w-auto">
                 <button onclick="openBulkAddModal()" class="flex-1 sm:flex-none bg-primary-blue text-white font-bold py-2 px-5 rounded-lg hover:opacity-90">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏ô</button>
                 <button onclick="openAddModal()" class="flex-1 sm:flex-none bg-primary-yellow text-primary-blue font-bold py-2 px-5 rounded-lg hover:opacity-90">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
             </div>
        </div>

        <div id="course-grid-container" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
            </div>

    </div>

    <div id="user-modal" class="hidden fixed inset-0 bg-black/60 z-50 flex justify-center items-center p-4">
        <div class="bg-white rounded-2xl p-6 w-full max-w-lg max-h-[90vh] overflow-y-auto">
            <h3 id="modal-title" class="text-xl font-semibold mb-4 text-primary-blue">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
            <form id="user-form" onsubmit="handleFormSubmit(event)" class="space-y-4">
                <input type="hidden" id="form-user-id">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="text-sm font-semibold text-slate-600" for="form-first-name">‡∏ä‡∏∑‡πà‡∏≠</label>
                        <input type="text" id="form-first-name" required class="w-full p-2 border border-slate-300 rounded-lg mt-1">
                    </div>
                    <div>
                        <label class="text-sm font-semibold text-slate-600" for="form-last-name">‡∏™‡∏Å‡∏∏‡∏•</label>
                        <input type="text" id="form-last-name" required class="w-full p-2 border border-slate-300 rounded-lg mt-1">
                    </div>
                </div>
                <div>
                    <label class="text-sm font-semibold text-slate-600" for="form-citizen-id">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</label>
                    <input type="text" id="form-citizen-id" required class="w-full p-2 border border-slate-300 rounded-lg mt-1">
                </div>
                <div>
                    <label class="text-sm font-semibold text-slate-600" for="form-student-id">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</label>
                    <input type="text" id="form-student-id" required class="w-full p-2 border border-slate-300 rounded-lg mt-1">
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                     <div>
                        <label class="text-sm font-semibold text-slate-600" for="form-course">‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£</label>
                        <input list="course-list" id="form-course" required class="w-full p-2 border border-slate-300 rounded-lg mt-1">
                        <datalist id="course-list"></datalist>
                    </div>
                     <div>
                        <label class="text-sm font-semibold text-slate-600" for="form-activity">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</label>
                        <input list="activity-list" id="form-activity" required class="w-full p-2 border border-slate-300 rounded-lg mt-1">
                        <datalist id="activity-list"></datalist>
                    </div>
                </div>
                <div>
                     <label class="text-sm font-semibold text-slate-600" for="form-seat">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á</label>
                     <input type="text" id="form-seat" required class="w-full p-2 border border-slate-300 rounded-lg mt-1">
                 </div>
                <div class="flex items-center gap-4 pt-4">
                    <button type="button" class="w-full py-3 px-4 rounded-xl font-bold bg-white text-slate-700 border border-slate-200" onclick="closeModal('user-modal')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="submit" id="form-submit-btn" class="w-full py-3 px-4 rounded-xl font-bold bg-primary-yellow text-primary-blue">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                </div>
            </form>
        </div>
    </div>

    <div id="bulk-add-modal" class="hidden fixed inset-0 bg-black/60 z-50 flex justify-center items-center p-4">
        <div class="bg-white rounded-2xl p-6 w-full max-w-lg max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-semibold mb-2 text-primary-blue">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏ô</h3>
            <p class="text-sm text-slate-500 mb-4">‡∏ß‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Spreadsheet ‡∏ï‡∏≤‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î</p>
            <form id="bulk-add-form" onsubmit="handleBulkAdd(event)" class="space-y-4">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="text-sm font-semibold text-slate-600" for="bulk-course-input">‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</label>
                        <input list="bulk-course-list" id="bulk-course-input" required class="w-full p-2 border border-slate-300 rounded-lg mt-1">
                        <datalist id="bulk-course-list"></datalist>
                    </div>
                     <div>
                        <label class="text-sm font-semibold text-slate-600" for="bulk-activity-input">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</label>
                        <input list="bulk-activity-list" id="bulk-activity-input" required class="w-full p-2 border border-slate-300 rounded-lg mt-1">
                        <datalist id="bulk-activity-list"></datalist>
                    </div>
                </div>
                <div>
                    <label class="text-sm font-semibold text-slate-600" for="bulk-data">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
                    <p class="text-xs text-slate-500">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: `‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏Ø`, `‡∏ä‡∏∑‡πà‡∏≠`, `‡∏™‡∏Å‡∏∏‡∏•`, `‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤`, `‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á`</p>
                    <textarea id="bulk-data" rows="8" required class="w-full p-2 border border-slate-300 rounded-lg mt-1 font-mono" placeholder="110...8,‡∏™‡∏°‡∏ä‡∏≤‡∏¢,‡πÉ‡∏à‡∏î‡∏µ,6601,A1&#10;120...9,‡∏™‡∏°‡∏´‡∏ç‡∏¥‡∏á,‡∏£‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô,6602,A2"></textarea>
                </div>
                <div class="flex items-center gap-4 pt-4">
                    <button type="button" class="w-full py-3 px-4 rounded-xl font-bold bg-white text-slate-700 border border-slate-200" onclick="closeModal('bulk-add-modal')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="submit" id="bulk-submit-btn" class="w-full py-3 px-4 rounded-xl font-bold bg-primary-yellow text-primary-blue">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxygDPMN_xmPFyYKClUktyivNqA-v4TRcD6xhJhhqb7u_jHHSg3un4C9HN0fY1j35Dbmw/exec'; // üëà ‡πÉ‡∏™‡πà URL ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£ Deploy
        let allStudentsData = []; // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥

        // --- Initial Setup ---
        document.addEventListener('DOMContentLoaded', fetchData);

        // --- Data Fetching and Display ---
        async function fetchData() {
            const gridContainer = document.getElementById("course-grid-container");
            gridContainer.innerHTML = `<p class="text-slate-500 text-center md:col-span-2 xl:col-span-3">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>`;
            try {
                const response = await fetch(`${WEB_APP_URL}?action=getDashboardData`);
                const result = await response.json();
                if (result.success) {
                    allStudentsData = result.allStudents;
                    populateDatalists(result.uniqueCourses, result.uniqueActivities);
                    filterAndDisplayData();
                } else {
                    throw new Error(result.message);
                }
            } catch (e) {
                gridContainer.innerHTML = `<p class="text-red-500 text-center md:col-span-2 xl:col-span-3">‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${e.message}</p>`;
            }
        }

function populateDatalists(courses, activities) {
            const courseFilter = document.getElementById('course-filter');
            const courseDatalist = document.getElementById('course-list');
            const bulkCourseDatalist = document.getElementById('bulk-course-list');
            const activityDatalist = document.getElementById('activity-list');
            const bulkActivityDatalist = document.getElementById('bulk-activity-list');

            // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            courseFilter.innerHTML = '<option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>';
            [courseDatalist, bulkCourseDatalist, activityDatalist, bulkActivityDatalist].forEach(el => el.innerHTML = '');

            courses.forEach(course => {
                // ‚≠ê ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö <select> ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡πÉ‡∏ä‡πâ .add() ‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥
                courseFilter.add(new Option(course, course));

                // ‚≠ê ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö <datalist> ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏°‡∏≤‡πÉ‡∏ä‡πâ .appendChild()
                const courseOption = document.createElement('option');
                courseOption.value = course;
                courseDatalist.appendChild(courseOption);
                bulkCourseDatalist.appendChild(courseOption.cloneNode(true)); // ‡πÉ‡∏ä‡πâ cloneNode ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û
            });
            
             activities.forEach(activity => {
                // ‚≠ê ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö <datalist> ‡∏Ç‡∏≠‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° ‡∏Å‡πá‡πÉ‡∏ä‡πâ .appendChild() ‡πÄ‡∏ä‡πà‡∏ô‡∏Å‡∏±‡∏ô
                const activityOption = document.createElement('option');
                activityOption.value = activity;
                activityDatalist.appendChild(activityOption);
                bulkActivityDatalist.appendChild(activityOption.cloneNode(true));
            });
        }
        
        function filterAndDisplayData() {
            const gridContainer = document.getElementById("course-grid-container");
            const selectedCourse = document.getElementById('course-filter').value;
            
            const filteredData = (selectedCourse === 'all') 
                ? allStudentsData 
                : allStudentsData.filter(row => row[5] === selectedCourse);

            if (filteredData.length > 0) {
                const groupedByCourse = filteredData.reduce((acc, row) => {
                    const courseName = row[5];
                    if (!acc[courseName]) acc[courseName] = [];
                    acc[courseName].push(row);
                    return acc;
                }, {});

                gridContainer.innerHTML = '';
                for (const courseName in groupedByCourse) {
                    const students = groupedByCourse[courseName];
                    
                    const groupedByActivity = students.reduce((acc, row) => {
                        const activityName = row[6] || '(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°)'; // ‚≠ê Group by activity
                        if (!acc[activityName]) acc[activityName] = [];
                        acc[activityName].push(row);
                        return acc;
                    }, {});

                    let activityTablesHtml = '';
                    for (const activityName in groupedByActivity) {
                        const activityStudents = groupedByActivity[activityName];
                        const studentRowsHtml = activityStudents.map(row => `
                            <tr class="border-b last:border-b-0 hover:bg-slate-50" data-id="${row[0]}">
                                <td class="p-2">${row[8] === '‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡πÅ‡∏•‡πâ‡∏ß' ? '‚úÖ' : '‚ö™Ô∏è'} ${row[2]} ${row[3]}</td>
                                <td class="p-2">${row[4]}</td>
                                <td class="p-2 font-semibold cursor-pointer hover:bg-yellow-100" onclick="editSeat(this)">${row[7]}</td>
                                <td class="p-2 text-center">
                                    <button class="text-blue-600 hover:underline text-xs" data-row='${JSON.stringify(row)}' onclick="openEditModal(this)">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                                    <button class="text-red-600 hover:underline text-xs ml-2" data-id="${row[0]}" onclick="handleDelete(this)">‡∏•‡∏ö</button>
                                </td>
                            </tr>
                        `).join('');

                        activityTablesHtml += `
                            <div class="mt-4">
                                <h4 class="px-3 py-1 bg-slate-200 text-slate-700 font-semibold text-sm">${activityName}</h4>
                                <table class="w-full text-sm">
                                    <tbody>${studentRowsHtml}</tbody>
                                </table>
                            </div>
                        `;
                    }
                    
                    const cardHtml = `
                        <div class="bg-white rounded-xl shadow-sm overflow-hidden flex flex-col">
                            <h3 class="p-3 bg-slate-100 text-primary-blue font-bold border-b">${courseName}</h3>
                            <div class="overflow-x-auto p-2">
                                <table class="w-full text-sm">
                                     <thead>
                                        <tr class="text-slate-600 text-xs">
                                            <th class="p-2 text-left w-[40%]">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
                                            <th class="p-2 text-left w-[25%]">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</th>
                                            <th class="p-2 text-left w-[15%]">‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á</th>
                                            <th class="p-2 text-center w-[20%]">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                        </tr>
                                    </thead>
                                </table>
                                ${activityTablesHtml}
                            </div>
                        </div>
                    `;
                    gridContainer.insertAdjacentHTML('beforeend', cardHtml);
                }
            } else {
                gridContainer.innerHTML = `<p class="text-slate-500 text-center md:col-span-2 xl:col-span-3">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>`;
            }
        }

        // --- Inline Editing Functions ---
        async function editSeat(cell) {
             if (cell.querySelector('input')) return;
             const originalValue = cell.textContent.trim();
             const row = cell.closest('tr');
             const id = row.dataset.id;
             cell.innerHTML = `<input type="text" value="${originalValue}" class="w-full p-1 border rounded bg-yellow-50 text-sm">`;
             const input = cell.querySelector('input');
             input.focus();
             input.select();

             const saveChange = async () => {
                 const newValue = input.value.trim();
                 cell.textContent = originalValue; // Revert visually first
                 if (newValue !== originalValue) {
                    cell.textContent = `...`;
                    const result = await serverRequest('updateSeat', { id: id, seat: newValue });
                    if (result.success) {
                        cell.textContent = newValue;
                        // Update local data
                        const student = allStudentsData.find(s => s[0] == id);
                        if (student) student[7] = newValue;
                    } else {
                        alert(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${result.message}`);
                        cell.textContent = originalValue;
                    }
                 }
             };
             input.addEventListener('blur', saveChange);
             input.addEventListener('keydown', (e) => {
                 if (e.key === 'Enter') input.blur();
                 else if (e.key === 'Escape') {
                     input.removeEventListener('blur', saveChange);
                     cell.textContent = originalValue;
                 }
             });
        }
        
        // --- Modal & Form Handling ---
        function openModal(modalId) { document.getElementById(modalId).classList.replace('hidden', 'flex'); }
        function closeModal(modalId) { document.getElementById(modalId).classList.replace('flex', 'hidden'); }

        function openAddModal() {
            document.getElementById('user-form').reset();
            document.getElementById('form-user-id').value = '';
            document.getElementById('modal-title').textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô';
            openModal('user-modal');
        }

        function openEditModal(btn) {
            const data = JSON.parse(btn.dataset.row);
            document.getElementById('form-user-id').value = data[0];
            document.getElementById('form-citizen-id').value = data[1];
            document.getElementById('form-first-name').value = data[2];
            document.getElementById('form-last-name').value = data[3];
            document.getElementById('form-student-id').value = data[4];
            document.getElementById('form-course').value = data[5];
            document.getElementById('form-activity').value = data[6]; // ‚≠ê
            document.getElementById('form-seat').value = data[7];     // ‚≠ê
            document.getElementById('modal-title').textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô';
            openModal('user-modal');
        }

        function openBulkAddModal() {
            document.getElementById('bulk-add-form').reset();
            openModal('bulk-add-modal');
        }

        async function handleFormSubmit(event) {
            event.preventDefault();
            const submitBtn = document.getElementById('form-submit-btn');
            submitBtn.disabled = true;
            submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

            const id = document.getElementById('form-user-id').value;
            const userData = {
                id: id,
                citizenId: document.getElementById('form-citizen-id').value,
                firstName: document.getElementById('form-first-name').value,
                lastName: document.getElementById('form-last-name').value,
                studentId: document.getElementById('form-student-id').value,
                course: document.getElementById('form-course').value,
                activity: document.getElementById('form-activity').value, // ‚≠ê
                seat: document.getElementById('form-seat').value
            };
            const action = id ? 'updateStudent' : 'addStudent';

            const result = await serverRequest(action, userData);
            alert(result.message);
            if (result.success) {
                closeModal('user-modal');
                await fetchData(); // Refresh all data
            }
            submitBtn.disabled = false;
            submitBtn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
        }
        
        async function handleBulkAdd(event) {
            event.preventDefault();
            const submitBtn = document.getElementById('bulk-submit-btn');
            const course = document.getElementById('bulk-course-input').value;
            const activity = document.getElementById('bulk-activity-input').value; // ‚≠ê
            const bulkData = document.getElementById('bulk-data').value.trim();

            if (!course || !activity || !bulkData) {
                alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£, ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°, ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô");
                return;
            }
            submitBtn.disabled = true;
            submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°...';

            const users = bulkData.split('\n').filter(line => line.trim() !== '').map(line => {
                const parts = line.split(/[\t,]/).map(p => p.trim());
                return {
                    citizenId: parts[0] || '',
                    firstName: parts[1] || '',
                    lastName: parts[2] || '',
                    studentId: parts[3] || '',
                    seat: parts[4] || '',
                    course: course,
                    activity: activity // ‚≠ê
                };
            });

            const result = await serverRequest('addMultipleUsers', users);
            alert(result.message);
            if (result.success) {
                closeModal('bulk-add-modal');
                await fetchData();
            }
            submitBtn.disabled = false;
            submitBtn.textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
        }

        async function handleDelete(btn) {
            const id = btn.dataset.id;
            if (confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ñ‡∏ß ID: ${id} ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                const result = await serverRequest('deleteStudent', { id: id });
                alert(result.message);
                if (result.success) {
                    await fetchData();
                }
            }
        }
        
        // --- Centralized Server Request Function ---
        async function serverRequest(action, data) {
            try {
                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: action, data: data })
                });
                return await response.json();
            } catch (error) {
                return { success: false, message: error.message };
            }
        }
    </script>
</body>
</html>
